#include "catch.hpp"
#include "transaction.h"
#include "utils.h"
#include "types.h"

TEST_CASE("Transaction call", "[transaction)]") {

  // given
  std::string hex = "f85f800182520894095e7baea6a6c7c4c2dfeb977efac326af552d870a801ba048b55bfa915ac795c431978d8a6a992b628d557da5ff759b307d495a36649353a0efffd310ac743f371de3b9f7f9cb56c0b28ad43601b4ab949f53faa07bd2c804";

  std::vector<uint8_t> bytes = Utils::hex2bin(hex);

  // when
  transaction_t transaction = Transaction::parse(bytes);

  // then
  CHECK(transaction_action_t::TRANSACTION_CALL == transaction.action);
  CHECK(uint256_t(0) == transaction.nonce);
  CHECK(uint256_t(0x01) == transaction.gas_price);
  CHECK(uint256_t(0x5208) == transaction.gas_limit);
  CHECK("095e7baea6a6c7c4c2dfeb977efac326af552d87" == 
    Utils::bytesTohex(transaction.to)
  );
  CHECK(uint256_t(0x0a) == transaction.value);
  CHECK("" == Utils::bytesTohex(transaction.data));
  CHECK(uint256_t(27) == transaction.v);
  CHECK("48b55bfa915ac795c431978d8a6a992b628d557da5ff759b307d495a36649353" == 
    Utils::bytesTohex(transaction.r)
  );
  CHECK("efffd310ac743f371de3b9f7f9cb56c0b28ad43601b4ab949f53faa07bd2c804" == 
    Utils::bytesTohex(transaction.s)
  );
}

TEST_CASE("Transaction contract", "[transaction)]") {

  // given
  std::string hex = "f901e4830263c8850879c08c7a830334508080b9018e6060604052341561000f57600080fd5b6101708061001e6000396000f3006060604052600436106100405763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166390b98a118114610045575b600080fd5b341561005057600080fd5b61007473ffffffffffffffffffffffffffffffffffffffff60043516602435610086565b60405190815260200160405180910390f35b600073521db06bf657ed1d6c98553a70319a8ddbac75a38373ffffffffffffffffffffffffffffffffffffffff811663a9059cbb83866040517c010000000000000000000000000000000000000000000000000000000063ffffffff851602815273ffffffffffffffffffffffffffffffffffffffff90921660048301526024820152604401600060405180830381600087803b151561012557600080fd5b6102c65a03f1151561013657600080fd5b5060019796505050505050505600a165627a7a723058203f339a2d354208169adb91e00c0cc7ffc9a9f9e67930818df75c3724b686179d002925a054a1805940f44a31be3fb3e284370f078f50f21e42cf0cbbad6a2f819211b2fea01d781f3d6b00ee9f1d7ffef90bd8ff78bfb0a88897b7f9a6c8cb4d923f7363f7";

  std::vector<uint8_t> bytes = Utils::hex2bin(hex);

  // when
  transaction_t transaction = Transaction::parse(bytes);

  // then
  CHECK(transaction_action_t::TRANSACTION_CREATE == transaction.action);
  CHECK(uint256_t(156616) == transaction.nonce);
  CHECK(uint256_t(0x0879c08c7a) == transaction.gas_price);
  CHECK(uint256_t(0x033450) == transaction.gas_limit);
  CHECK(uint256_t(0x0) == transaction.value);
  CHECK("6060604052341561000f57600080fd5b6101708061001e6000396000f3006060604052600436106100405763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166390b98a118114610045575b600080fd5b341561005057600080fd5b61007473ffffffffffffffffffffffffffffffffffffffff60043516602435610086565b60405190815260200160405180910390f35b600073521db06bf657ed1d6c98553a70319a8ddbac75a38373ffffffffffffffffffffffffffffffffffffffff811663a9059cbb83866040517c010000000000000000000000000000000000000000000000000000000063ffffffff851602815273ffffffffffffffffffffffffffffffffffffffff90921660048301526024820152604401600060405180830381600087803b151561012557600080fd5b6102c65a03f1151561013657600080fd5b5060019796505050505050505600a165627a7a723058203f339a2d354208169adb91e00c0cc7ffc9a9f9e67930818df75c3724b686179d0029" == 
    Utils::bytesTohex(transaction.data)
  );
  CHECK(uint256_t(37) == transaction.v);
  CHECK("54a1805940f44a31be3fb3e284370f078f50f21e42cf0cbbad6a2f819211b2fe" == 
    Utils::bytesTohex(transaction.r)
  );
  CHECK("1d781f3d6b00ee9f1d7ffef90bd8ff78bfb0a88897b7f9a6c8cb4d923f7363f7" == 
    Utils::bytesTohex(transaction.s)
  );
}

TEST_CASE("Transaction call contract", "[transaction)]") {

  // given
  std::string hex = "f901958203fa85028fa6ae00830b5b519477598616174a411ae9a1e197640903faab9ac1ae880113806225a3c428b9012459f9cf0c000000000000000000000000000000000000000000000000000000000000004b00000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000041d2eaa477e07126513ab0c83723174b5e2e921382f216647f3cd0b88bffb97faf1767bd51418804947913b905809be585882f350bb272275943e4efdede347c421b0000000000000000000000000000000000000000000000000000000000000025a06a744032ad48eb8188d2f03ccc57bf9d91a45f780152288ee7abb700ee286393a02c2171570feb5e6855a62c4a9562b219ea4daeea98376a06f170e352035d353c";

  std::vector<uint8_t> bytes = Utils::hex2bin(hex);

  // when
  transaction_t transaction = Transaction::parse(bytes);

  // then
  CHECK(transaction_action_t::TRANSACTION_CALL == transaction.action);
  CHECK(uint256_t(1018) == transaction.nonce);
  CHECK(uint256_t(0x028fa6ae00) == transaction.gas_price);
  CHECK(uint256_t(0x0b5b51) == transaction.gas_limit);
  CHECK("77598616174a411ae9a1e197640903faab9ac1ae" == 
    Utils::bytesTohex(transaction.to)
  );
  CHECK(uint256_t(0x0113806225a3c428) == transaction.value);
  CHECK("59f9cf0c000000000000000000000000000000000000000000000000000000000000004b00000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000041d2eaa477e07126513ab0c83723174b5e2e921382f216647f3cd0b88bffb97faf1767bd51418804947913b905809be585882f350bb272275943e4efdede347c421b00000000000000000000000000000000000000000000000000000000000000" == 
    Utils::bytesTohex(transaction.data)
  );
  CHECK(uint256_t(37) == transaction.v);
  CHECK("6a744032ad48eb8188d2f03ccc57bf9d91a45f780152288ee7abb700ee286393" == 
    Utils::bytesTohex(transaction.r)
  );
  CHECK("2c2171570feb5e6855a62c4a9562b219ea4daeea98376a06f170e352035d353c" == 
    Utils::bytesTohex(transaction.s)
  );
}