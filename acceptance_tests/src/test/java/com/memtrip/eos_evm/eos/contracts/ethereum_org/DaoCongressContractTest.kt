package com.memtrip.eos_evm.eos.contracts.ethereum_org

import com.memtrip.eos.http.rpc.Api
import com.memtrip.eos_evm.eos.Config
import com.memtrip.eos_evm.eos.SetupTransactions
import com.memtrip.eos_evm.eos.evm.contracts.ethereum_org.DaoCongressContract
import com.memtrip.eos_evm.eos.state.GetCode
import com.memtrip.eos_evm.ethereum.pad256
import com.memtrip.eos_evm.ethereum.toHexString
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import org.junit.Assert
import org.junit.Assert.assertEquals
import org.junit.Test
import java.util.concurrent.TimeUnit

class DaoCongressContractTest {

    private val okHttpClient = OkHttpClient.Builder()
        .addInterceptor(HttpLoggingInterceptor().setLevel(HttpLoggingInterceptor.Level.BODY))
        .connectTimeout(10, TimeUnit.SECONDS)
        .readTimeout(10, TimeUnit.SECONDS)
        .writeTimeout(10, TimeUnit.SECONDS)
        .build()

    private val chainApi = Api(Config.CHAIN_API_BASE_URL, okHttpClient).chain

    private val setupTransactions = SetupTransactions(chainApi)

    private val getCode = GetCode(chainApi)

    @Test
    fun `The DaoCongress contract is created`() {

        // given
        val (newAccountName, newAccountPrivateKey, newEthAccount) = setupTransactions.seedWithEvmBalance(30000)

        val contract = DaoCongressContract(
            newAccountName,
            newAccountPrivateKey,
            newEthAccount
        )

        // when
        val createContractResponse = contract.createContract(
            10000,
            100,
            100
        ).blockingGet()

        // then
        assertEquals(202, createContractResponse.statusCode)

        // and when
        val getCodeResult = getCode.getAll(
            contract.accountIdentifier.pad256().toHexString()
        ).blockingGet()

        if (getCodeResult !is GetCode.Record.Multiple) Assert.fail("code record not found") else {
            assertEquals(1, getCodeResult.items.size)
            assertEquals(
                "6080604052600436106101095760003560e01c80638f4ffcb111610095578063bcca1fd311610064578063bcca1fd314610a5b578063c127c24714610aaa578063d3c0715b14610b92578063eceb294514610c84578063f2fde38b14610d9857610109565b80638f4ffcb1146105e4578063aa02a90f146106f6578063b1050da514610721578063b9f256cd146108be57610109565b8063400e3949116100dc578063400e39491461041e5780635daf08ca1461044957806369bd3436146105375780638160f0b5146105625780638da5cb5b1461058d57610109565b8063013cf08b146101765780630b1ca49a14610296578063237e9492146102e757806339106821146103b9575b7fa398b89ba344a0b23a0b9de53db298b2a1a868b396c1878b7e9dcbafecd49b133334604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a1005b34801561018257600080fd5b506101af6004803603602081101561019957600080fd5b8101908080359060200190929190505050610de9565b604051808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001898152602001806020018881526020018715151515815260200186151515158152602001858152602001848152602001838152602001828103825289818151815260200191508051906020019080838360005b83811015610253578082015181840152602081019050610238565b50505050905090810190601f1680156102805780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b3480156102a257600080fd5b506102e5600480360360208110156102b957600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610f16565b005b3480156102f357600080fd5b506103b76004803603604081101561030a57600080fd5b81019080803590602001909291908035906020019064010000000081111561033157600080fd5b82018360208201111561034357600080fd5b8035906020019184600183028401116401000000008311171561036557600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050611239565b005b3480156103c557600080fd5b50610408600480360360208110156103dc57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611544565b6040518082815260200191505060405180910390f35b34801561042a57600080fd5b5061043361155c565b6040518082815260200191505060405180910390f35b34801561045557600080fd5b506104826004803603602081101561046c57600080fd5b8101908080359060200190929190505050611562565b604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b838110156104fa5780820151818401526020810190506104df565b50505050905090810190601f1680156105275780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b34801561054357600080fd5b5061054c611651565b6040518082815260200191505060405180910390f35b34801561056e57600080fd5b50610577611657565b6040518082815260200191505060405180910390f35b34801561059957600080fd5b506105a261165d565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156105f057600080fd5b506106f46004803603608081101561060757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019064010000000081111561066e57600080fd5b82018360208201111561068057600080fd5b803590602001918460018302840111640100000000831117156106a257600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050611682565b005b34801561070257600080fd5b5061070b611899565b6040518082815260200191505060405180910390f35b34801561072d57600080fd5b506108a86004803603608081101561074457600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291908035906020019064010000000081111561078b57600080fd5b82018360208201111561079d57600080fd5b803590602001918460018302840111640100000000831117156107bf57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192908035906020019064010000000081111561082257600080fd5b82018360208201111561083457600080fd5b8035906020019184600183028401116401000000008311171561085657600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929050505061189f565b6040518082815260200191505060405180910390f35b3480156108ca57600080fd5b50610a45600480360360808110156108e157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291908035906020019064010000000081111561092857600080fd5b82018360208201111561093a57600080fd5b8035906020019184600183028401116401000000008311171561095c57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290803590602001906401000000008111156109bf57600080fd5b8201836020820111156109d157600080fd5b803590602001918460018302840111640100000000831117156109f357600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050611b8a565b6040518082815260200191505060405180910390f35b348015610a6757600080fd5b50610aa860048036036060811015610a7e57600080fd5b81019080803590602001909291908035906020019092919080359060200190929190505050611bf8565b005b348015610ab657600080fd5b50610b9060048036036040811015610acd57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190640100000000811115610b0a57600080fd5b820183602082011115610b1c57600080fd5b80359060200191846001830284011164010000000083111715610b3e57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050611cb8565b005b348015610b9e57600080fd5b50610c6e60048036036060811015610bb557600080fd5b810190808035906020019092919080351515906020019092919080359060200190640100000000811115610be857600080fd5b820183602082011115610bfa57600080fd5b80359060200191846001830284011164010000000083111715610c1c57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050611ef0565b6040518082815260200191505060405180910390f35b348015610c9057600080fd5b50610d7e60048036036080811015610ca757600080fd5b8101908080359060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190640100000000811115610cf857600080fd5b820183602082011115610d0a57600080fd5b80359060200191846001830284011164010000000083111715610d2c57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929050505061214c565b604051808215151515815260200191505060405180910390f35b348015610da457600080fd5b50610de760048036036020811015610dbb57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061222e565b005b60048181548110610df657fe5b90600052602060002090600a02016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806001015490806002018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ece5780601f10610ea357610100808354040283529160200191610ece565b820191906000526020600020905b815481529060010190602001808311610eb157829003601f168201915b5050505050908060030154908060040160009054906101000a900460ff16908060040160019054906101000a900460ff16908060050154908060060154908060070154905089565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610f6f57600080fd5b6000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541415610fbc57600080fd5b6000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490505b600160078054905003811015611175576007600182018154811061102157fe5b90600052602060002090600302016007828154811061103c57fe5b90600052602060002090600302016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600182018160010190805460018160011615610100020316600290046110d89291906122ca565b50600282015481600201559050508060066000600784815481106110f857fe5b906000526020600020906003020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508080600101915050611001565b506000600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506007600160078054905003815481106111d057fe5b9060005260206000209060030201600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006112169190612351565b6002820160009055505060078054809190600190036112359190612399565b5050565b60006004838154811061124857fe5b90600052602060002090600a0201905080600301544211801561127a57508060040160009054906101000a900460ff16155b801561136157508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16816001015483604051602001808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1660601b815260140183815260200182805190602001908083835b6020831061131d57805182526020820191506020810190506020830392506112fa565b6001836020036101000a0380198251168184511680821785525050505050509050019350505050604051602081830303815290604052805190602001208160070154145b80156113735750600154816005015410155b61137c57600080fd5b600354816006015413156114b55760018160040160006101000a81548160ff02191690831515021790555060008160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168260010154846040518082805190602001908083835b6020831061141d57805182526020820191506020810190506020830392506113fa565b6001836020036101000a03801982511681845116808217855250505050505090500191505060006040518083038185875af1925050503d806000811461147f576040519150601f19603f3d011682016040523d82523d6000602084013e611484565b606091505b505090508061149257600080fd5b60018260040160016101000a81548160ff021916908315150217905550506114d3565b60008160040160016101000a81548160ff0219169083151502179055505b7fd220b7272a8b6d0d7d6bcdace67b936a8f175e6d5c1b3ee438b72256b32ab3af83826006015483600501548460040160019054906101000a900460ff16604051808581526020018481526020018381526020018215151515815260200194505050505060405180910390a1505050565b60066020528060005260406000206000915090505481565b60055481565b6007818154811061156f57fe5b90600052602060002090600302016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116415780601f1061161657610100808354040283529160200191611641565b820191906000526020600020905b81548152906001019060200180831161162457829003601f168201915b5050505050908060020154905083565b60025481565b60015481565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008290508073ffffffffffffffffffffffffffffffffffffffff166323b872dd8630876040518463ffffffff1660e01b8152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019350505050602060405180830381600087803b15801561174257600080fd5b505af1158015611756573d6000803e3d6000fd5b505050506040513d602081101561176c57600080fd5b810190808051906020019092919050505061178657600080fd5b7f0eeb71b8926d7ed8f47a2cedf6b9b204e2001344c7fa20c696c9f06ea7c413c685858585604051808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001828103825283818151815260200191508051906020019080838360005b8381101561185557808201518184015260208101905061183a565b50505050905090810190601f1680156118825780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a15050505050565b60035481565b600080600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205414156118ed57600080fd5b6004805480919060010161190191906123cb565b905060006004828154811061191257fe5b90600052602060002090600a02019050858160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550848160010181905550838160020190805190602001906119869291906123fd565b50858584604051602001808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1660601b815260140183815260200182805190602001908083835b602083106119fb57805182526020820191506020810190506020830392506119d8565b6001836020036101000a0380198251168184511680821785525050505050509050019350505050604051602081830303815290604052805190602001208160070181905550603c600254024201816003018190555060008160040160006101000a81548160ff02191690831515021790555060008160040160016101000a81548160ff021916908315150217905550600081600501819055507f646fec02522b41e7125cfc859a64fd4f4cefd5dc3b6237ca0abe251ded1fa88182878787604051808581526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b83811015611b37578082015181840152602081019050611b1c565b50505050905090810190601f168015611b645780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a16001820160058190555081915050949350505050565b600080600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541415611bd857600080fd5b611bee85670de0b6b3a76400008602858561189f565b9050949350505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611c5157600080fd5b8260018190555081600281905550806003819055507fa439d3fa452be5e0e1e24a8145e715f4fd8b9c08c96a42fd82a855a85e5d57de60015460025460035460405180848152602001838152602001828152602001935050505060405180910390a1505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611d1157600080fd5b6000600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490506000811415611dbe57600780549050600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060078054809190600101611dbb9190612399565b90505b60405180606001604052808473ffffffffffffffffffffffffffffffffffffffff1681526020018381526020014281525060078281548110611dfc57fe5b906000526020600020906003020160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001019080519060200190611e6d92919061247d565b50604082015181600201559050507f27b022af4a8347100c7a041ce5ccf8e14d644ff05de696315196faae8cd50c9b836001604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001821515151581526020019250505060405180910390a1505050565b600080600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541415611f3e57600080fd5b600060048581548110611f4d57fe5b90600052602060002090600a020190508060090160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615611fb657600080fd5b60018160090160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555080600501600081548092919060010191905055508315612043578060060160008154809291906001019190505550612059565b8060060160008154809291906001900391905055505b7fc34f869b7ff431b034b7b9aea9822dac189a685e0b015c7d1be3add3f89128e88585338660405180858152602001841515151581526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001828103825283818151815260200191508051906020019080838360005b838110156121005780820151818401526020810190506120e5565b50505050905090810190601f16801561212d5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a180600501549150509392505050565b6000806004868154811061215c57fe5b90600052602060002090600a02019050848484604051602001808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1660601b815260140183815260200182805190602001908083835b602083106121e057805182526020820191506020810190506020830392506121bd565b6001836020036101000a038019825116818451168082178552505050505050905001935050505060405160208183030381529060405280519060200120816007015414915050949350505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461228757600080fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106123035780548555612340565b8280016001018555821561234057600052602060002091601f016020900482015b8281111561233f578254825591600101919060010190612324565b5b50905061234d91906124fd565b5090565b50805460018160011615610100020316600290046000825580601f106123775750612396565b601f01602090049060005260206000209081019061239591906124fd565b5b50565b8154818355818111156123c6576003028160030283600052602060002091820191016123c59190612522565b5b505050565b8154818355818111156123f857600a0281600a0283600052602060002091820191016123f79190612580565b5b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061243e57805160ff191683800117855561246c565b8280016001018555821561246c579182015b8281111561246b578251825591602001919060010190612450565b5b50905061247991906124fd565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106124be57805160ff19168380011785556124ec565b828001600101855582156124ec579182015b828111156124eb5782518255916020019190600101906124d0565b5b5090506124f991906124fd565b5090565b61251f91905b8082111561251b576000816000905550600101612503565b5090565b90565b61257d91905b8082111561257957600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006125689190612351565b600282016000905550600301612528565b5090565b90565b61263391905b8082111561262f57600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560018201600090556002820160006125ce9190612351565b60038201600090556004820160006101000a81549060ff02191690556004820160016101000a81549060ff02191690556005820160009055600682016000905560078201600090556008820160006126269190612636565b50600a01612586565b5090565b90565b5080546000825560020290600052602060002090810190612657919061265a565b50565b6126c191905b808211156126bd57600080820160006101000a81549060ff02191690556000820160016101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006126b49190612351565b50600201612660565b5090565b9056fea265627a7a723158204663f0ba8ad251c9320d7a7a12ce2a50560e189b2142b2965da24648a603f66464736f6c63430005100032",
                getCodeResult.items[0].code
            )
            assertEquals(getCodeResult.items[0].address, contract.accountIdentifier.pad256().toHexString())
        }
    }
}